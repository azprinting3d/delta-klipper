# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.


#################################################
##                 ABL MACRO                   ##
#################################################
[gcode_macro ABL]
gcode:
   G28
   BED_MESH_CALIBRATE

#################################################
##            START PRINT MACRO                ##
#################################################
[gcode_macro START_PRINT]
gcode:
   M117 HOMING
   G90
   G28
   #G92 E0
   #{% set BED_TEMP = params.BED_TEMP|default(0)|float %}
   #{% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(0)|float %}
   #M117 Espera temperaturas
   #M140 S{BED_TEMP}
   #{% if printer.heater_bed.temperature > params.BED_TEMP|float*0 %}
        #M140 S{BED_TEMP}
        #M109 S{EXTRUDER_TEMP}
        #M190 S{BED_TEMP}
    #{% else %}
        #M190 S{params.BED_TEMP|float*0}
        #M109 S{EXTRUDER_TEMP}
        #M190 S{BED_TEMP}
    #{% endif %}
    #M117 A Imprimir...
     
#################################################
##             END PRINT MACRO                 ##
#################################################
[gcode_macro END_PRINT]
gcode:
   M140 S0
   M104 S0
   M106 S0
   G91
   G1 E-6 F300
   G90
   G28
   M84 E
   M117 Print finish.

#################################################
##             CANCEL PRINT MACRO              ##
#################################################
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    M91
    G1 E-4
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT
    G28

#################################################
##             PAUSE PRINT MACRO               ##
#################################################
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
# change this if you need more or less extrusion
variable_extrude: 1.0
gcode:
    ##### read E from pause macro #####
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    ##### set park positon for x and y #####
    # default is your max posion from your printer.cfg
    {% set x_park = printer.toolhead.axis_maximum.x|float - 5.0 %}
    {% set y_park = printer.toolhead.axis_maximum.y|float - 5.0 %}
    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% if act_z < (max_z - 2.0) %}
        {% set z_safe = 2.0 %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    ##### end of definitions #####
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{E} F2100
    G1 Z250 F900
    G90

#################################################
##             RESUME PRINT MACRO              ##
#################################################
[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
    ##### read E from pause macro #####
    {% set E = printer["gcode_macro PAUSE"].extrude|float %}
    ##### end of definitions #####
    G91
    G1 E{E} F2100
    RESTORE_GCODE_STATE NAME=PAUSE_state
    BASE_RESUME



#################################################
##             M600 PRINT MACRO                ##
#################################################
[gcode_macro M600]
gcode:
   PAUSE

#################################################
##            PID_HOTEND PRINT MACRO           ##
#################################################
[gcode_macro PID_HOTEND]
description: PID calibration of the hotend with set temp.
gcode:
  M106
  {% set TARGET_TEMP = params.TARGET_TEMP|default(230)|float %} 
  PID_CALIBRATE HEATER=extruder TARGET={TARGET_TEMP}
  SAVE_CONFIG

#################################################
##             PID_BED PRINT MACRO             ##
#################################################
[gcode_macro PID_BED]
description: PID calibration of the hotend with set temp.
gcode:
  {% set TARGET_TEMP = params.TARGET_TEMP|default(60)|float %} 
  PID_CALIBRATE HEATER=heater_bed TARGET={TARGET_TEMP}
  SAVE_CONFIG

#################################################
##              KLIPPER BACKUP                 ##
#################################################
[gcode_macro update_git]
gcode:
    RUN_SHELL_COMMAND CMD=update_git_script

[gcode_shell_command update_git_script]
command: bash /home/pi/printer_data/klipper-backup/script.sh
timeout: 90.0
verbose: True



  